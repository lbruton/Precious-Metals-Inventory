<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, user-scalable=yes">
  <title>Precious Metals Tool</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #333333;
      --box: #f8f9fa;
      --shadow: 0 2px 8px #00000020;
      --btn: #0d6efd;
      --btn-hover: #0b5ed7;
      --accent: #0d6efd;
      --input: #ffffff;
      --danger: #dc3545;
      --danger-hover: #bb2d3b;
      --premium: #ffc107;
      --profit: #28a745;
      --loss: #dc3545;
      --collectable: #6c757d;
      --header-bg: #e9ecef;
      --header-fg: #212529;
      --table-header: #e9ecef;
      --row-even: #f8f9fa;
      --row-odd: #ffffff;
      --pagination-gap: 0.35rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      max-width: 90vw;
      margin: 1.5rem auto;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      letter-spacing: 1px;
      color: var(--accent);
    }

    .container {
      display: grid;
      gap: 1.5rem;
    }

    section {
      background: var(--box);
      padding: 1.25rem;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    form {
      display: grid;
      gap: 1rem;
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--accent);
    }

    input, select, button {
      padding: 0.6rem;
      border-radius: 5px;
      border: 1px solid #ced4da;
      font-size: 1rem;
      width: 100%;
      background: var(--input);
      color: var(--fg);
    }

    input:focus, select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    .currency-input {
      position: relative;
      padding-left: 1.5rem;
    }

    .currency-input::before {
      content: "$";
      position: absolute;
      left: 0.5rem;
      top: 0.6rem;
      color: var(--accent);
    }

    .btn {
      background: var(--btn);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      margin: 0.3rem;
      text-align: center;
    }

    .btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .danger {
      background: var(--danger);
    }

    .danger:hover {
      background: var(--danger-hover);
    }

    .premium {
      background: var(--premium);
      color: #212529;
    }

    .premium:hover {
      background: #e0a800;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      border: 1px solid #dee2e6;
      padding: 0.5rem;
      text-align: center;
    }

    th {
      background: var(--table-header);
      color: var(--header-fg);
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }

    th:hover {
      background: #dde0e3;
    }

    /* Alternating row colors */
    tr:nth-child(even) {
      background-color: var(--row-even);
    }

    tr:nth-child(odd) {
      background-color: var(--row-odd);
    }

    .sort-indicator {
      margin-left: 5px;
      font-weight: bold;
    }

    .totals {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .total-card {
      padding: 1rem;
      background: var(--box);
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .total-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--accent);
      text-align: center;
    }

    .action-buttons {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .spot-history-buttons {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      justify-content: center;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--box);
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 90%;
      max-height: 80%;
      overflow: auto;
      border: 1px solid #ced4da;
    }

    /* Import button specific styling */
    #importBtn {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    #importBtn input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .boating-accident-section {
      margin-top: 2rem;
      text-align: center;
    }

    .boating-accident-section button {
      padding: 0.7rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .boating-accident-section button:hover {
      background: var(--danger-hover);
      transform: scale(1.03);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Toggle Switch for Collectable */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--accent);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    input:disabled + .slider {
      background-color: var(--collectable);
      opacity: 0.6;
    }

    .collectable-note {
      font-size: 0.75rem;
      color: var(--collectable);
      margin-top: 0.25rem;
      text-align: center;
    }

    .collectable-explanation {
      font-size: 0.85rem;
      color: var(--collectable);
      margin-top: 0.5rem;
      text-align: center;
      font-style: italic;
    }

    /* Pagination Styles */
    .pagination-section {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .pagination-container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .pagination-controls {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 1rem;
      padding: 0.25rem 0;
    }

    .pagination-left,
    .pagination-right {
      display: flex;
      gap: 0.5rem;
    }

    .pagination-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .pagination-info-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-numbers {
      display: flex;
      gap: 0.25rem;
      justify-content: center;
      max-width: 20%;
    }

    .page-numbers button {
      min-width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background: var(--box);
      color: var(--fg);
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .page-numbers button:hover:not(.active) {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .page-numbers button.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      font-weight: 600;
    }

    .pagination-btn {
      min-width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background: var(--box);
      color: var(--fg);
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .pagination-btn:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-info {
      min-width: 80px;
      text-align: center;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--fg);
    }

    .pagination-select {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background: var(--input);
      color: var(--fg);
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }

    .pagination-select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    /* Search Functionality Styles */
    .search-section {
      margin-bottom: 1rem;
    }

    .search-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    #searchInput {
      flex: 1;
      padding: 0.6rem;
      border-radius: 5px;
      border: 1px solid #ced4da;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    #searchInput:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    #clearSearchBtn {
      width: auto;
      padding: 0.6rem 1rem;
      background: var(--collectable);
      color: white;
    }

    #clearSearchBtn:hover {
      background: #5a6268;
    }

    .search-results-info {
      font-size: 0.85rem;
      color: var(--collectable);
      margin-top: 0.5rem;
      text-align: right;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .pagination-controls {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .pagination-left,
      .pagination-right {
        justify-content: center;
        margin-bottom: 0.5rem;
      }

      .pagination-center {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .pagination-info-controls {
        flex-direction: column;
        align-items: center;
      }

      .page-numbers {
        max-width: 100%;
      }

      .search-container {
        flex-direction: column;
        align-items: stretch;
      }

      #clearSearchBtn {
        width: 100%;
      }
    }

    @media (min-width: 600px) {
      .grid-2 {
        grid-template-columns: repeat(2, 1fr);
      }

      .action-buttons, .spot-history-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1>Precious Metals Tool</h1>

  <div class="container">
    <!-- Spot Prices -->
    <section class="spot-prices">
      <div class="grid grid-2">
        <div class="spot-input">
          <label for="userSpotPriceSilver">Silver Spot Price</label>
          <div class="currency-input">
            <input type="number" id="userSpotPriceSilver" min="0" step="0.01" placeholder="Set spot $">
          </div>
          <div class="grid grid-2">
            <button class="btn" id="saveSpotBtnSilver">Save</button>
            <button class="btn" id="resetSpotBtnSilver">Reset</button>
          </div>
          <div>Current: <span id="spotPriceDisplaySilver">$ -</span></div>
        </div>
        <div class="spot-input">
          <label for="userSpotPriceGold">Gold Spot Price</label>
          <div class="currency-input">
            <input type="number" id="userSpotPriceGold" min="0" step="0.01" placeholder="Set spot $">
          </div>
          <div class="grid grid-2">
            <button class="btn" id="saveSpotBtnGold">Save</button>
            <button class="btn" id="resetSpotBtnGold">Reset</button>
          </div>
          <div>Current: <span id="spotPriceDisplayGold">$ -</span></div>
        </div>
      </div>
    </section>

    <!-- Spot History Buttons -->
    <section class="spot-history-section">
      <h2 style="margin-bottom: 0.75rem; text-align: center; font-size: 1.2rem; color: var(--accent);">Spot Price History</h2>
      <div class="spot-history-buttons">
        <button class="btn" id="showSpotHistoryBtn">Show Spot History</button>
        <button class="btn danger" id="clearSpotHistoryBtn">Clear Spot History</button>
      </div>
    </section>

    <!-- Totals -->
    <section class="totals-section">
      <div class="totals">
        <div class="total-card">
          <div class="total-title">Silver Totals</div>
          <div>Total Items: <span id="totalItemsSilver">0</span></div>
          <div>Total Weight: <span id="totalWeightSilver">0.00</span> oz</div>
          <div>Current Value: <span id="currentValueSilver">$0.00</span></div>
          <div>Purchase Price: <span id="totalPurchasedSilver">$0.00</span></div>
          <div>Premium Paid: <span id="totalPremiumSilver">$0.00</span></div>
          <div>Total Loss/Profit: <span id="lossProfitSilver">$0.00</span></div>
        </div>
        <div class="total-card">
          <div class="total-title">Gold Totals</div>
          <div>Total Items: <span id="totalItemsGold">0</span></div>
          <div>Total Weight: <span id="totalWeightGold">0.00</span> oz</div>
          <div>Current Value: <span id="currentValueGold">$0.00</span></div>
          <div>Purchase Price: <span id="totalPurchasedGold">$0.00</span></div>
          <div>Premium Paid: <span id="totalPremiumGold">$0.00</span></div>
          <div>Total Loss/Profit: <span id="lossProfitGold">$0.00</span></div>
        </div>
        <div class="total-card">
          <div class="total-title">All Totals</div>
          <div>Total Items: <span id="totalItemsAll">0</span></div>
          <div>Total Weight: <span id="totalWeightAll">0.00</span> oz</div>
          <div>Current Value: <span id="currentValueAll">$0.00</span></div>
          <div>Purchase Price: <span id="totalPurchasedAll">$0.00</span></div>
          <div>Premium Paid: <span id="totalPremiumAll">$0.00</span></div>
          <div>Total Loss/Profit: <span id="lossProfitAll">$0.00</span></div>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="form-section">
      <form id="inventoryForm">
        <div class="grid grid-2">
          <div>
            <label for="itemMetal">Metal</label>
            <select id="itemMetal">
              <option value="Silver">Silver</option>
              <option value="Gold">Gold</option>
            </select>
          </div>
          <div>
            <label for="itemType">Type</label>
            <select id="itemType">
              <option value="Round">Round</option>
              <option value="Bar">Bar</option>
              <option value="Coin">Coin</option>
              <option value="Note">Note</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="itemQty">Quantity</label>
            <input type="number" id="itemQty" min="1" step="1" required>
          </div>
          <div>
            <label for="itemWeight">Weight (oz)</label>
            <input type="number" id="itemWeight" step="0.0001" min="0.0001" required>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="itemName">Name</label>
            <input type="text" id="itemName" required>
          </div>
          <div>
            <label for="purchaseLocation">Purchase Location</label>
            <input type="text" id="purchaseLocation" required>
          </div>
          <div>
            <label for="itemPrice">Purchase Price ($)</label>
            <div class="currency-input">
              <input type="number" id="itemPrice" step="0.01" min="0" required>
            </div>
          </div>
          <div>
            <label for="itemDate">Purchase Date</label>
            <input type="date" id="itemDate" required>
          </div>
        </div>

        <div style="margin-top: 0.5rem;">
          <button type="submit" class="btn">Add to Inventory</button>
        </div>
      </form>
    </section>

    <!-- Search Functionality -->
    <section class="search-section">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search inventory by metal, name, type, location, date...">
        <button class="btn" id="clearSearchBtn">Clear</button>
      </div>
      <div class="search-results-info" id="searchResultsInfo"></div>
    </section>

    <!-- Table -->
    <section class="table-section">
      <table id="inventoryTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Metal</th>
            <th>Qty</th>
            <th>Type</th>
            <th>Name</th>
            <th>Weight (oz)</th>
            <th>Purchase Price ($)</th>
            <th>Spot Price ($/oz)</th>
            <th>Premium Paid ($/oz)</th>
            <th>Total Premium Paid ($)</th>
            <th>Purchase Location</th>
            <th>Date</th>
            <th>Collectable</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Pagination Controls -->
      <section class="pagination-section">
        <div class="pagination-container">
          <div class="pagination-controls">
            <div class="pagination-left">
              <button id="firstPage" class="pagination-btn" title="First Page">&laquo;</button>
              <button id="prevPage" class="pagination-btn" title="Previous Page">&lsaquo;</button>
            </div>

            <div class="pagination-center">
              <div class="page-numbers" id="pageNumbers"></div>
              <div class="pagination-info-controls">
                <span id="paginationInfo" class="pagination-info"></span>
                <select id="itemsPerPage" class="pagination-select">
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="25" selected>25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>

            <div class="pagination-right">
              <button id="nextPage" class="pagination-btn" title="Next Page">&rsaquo;</button>
              <button id="lastPage" class="pagination-btn" title="Last Page">&raquo;</button>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- Action Buttons -->
    <section class="action-section">
      <div class="action-buttons">
        <label class="btn" id="importBtn">
          Import CSV
          <input type="file" id="importFile" accept=".csv" hidden>
        </label>

        <button class="btn" onclick="downloadCSV()">Export CSV</button>
      </div>
    </section>
  </div>

  <!-- Boating Accident Button in its own section at the bottom -->
  <section class="boating-accident-section">
    <button id="boatingAccidentBtn">Boating Accident</button>
  </section>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 style="margin-bottom: 1rem; color: var(--accent);">Edit Inventory Item</h2>
      <form id="editForm">
        <div class="grid grid-2">
          <div>
            <label for="editMetal">Metal</label>
            <select id="editMetal">
              <option value="Silver">Silver</option>
              <option value="Gold">Gold</option>
            </select>
          </div>
          <div>
            <label for="editType">Type</label>
            <select id="editType">
              <option value="Round">Round</option>
              <option value="Bar">Bar</option>
              <option value="Coin">Coin</option>
              <option value="Note">Note</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="editQty">Quantity</label>
            <input type="number" id="editQty" min="1" step="1" required>
          </div>
          <div>
            <label for="editWeight">Weight (oz)</label>
            <input type="number" id="editWeight" step="0.0001" min="0.0001" required>
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label for="editName">Name</label>
            <input type="text" id="editName" required>
          </div>
          <div>
            <label for="editPurchaseLocation">Purchase Location</label>
            <input type="text" id="editPurchaseLocation" required>
          </div>
          <div>
            <label for="editPrice">Purchase Price ($)</label>
            <div class="currency-input">
              <input type="number" id="editPrice" step="0.01" min="0" required>
            </div>
          </div>
          <div>
            <label for="editDate">Purchase Date</label>
            <input type="date" id="editDate" required>
          </div>
        </div>

        <!-- Spot Price input field for editing historical spot prices -->
        <div class="grid grid-2">
          <div>
            <label for="editSpotPrice">Spot Price ($/oz)</label>
            <div class="currency-input">
              <input type="number" id="editSpotPrice" step="0.01" min="0" required>
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem; text-align: right;">
          <button type="button" class="btn" id="cancelEdit">Cancel</button>
          <button type="submit" class="btn premium">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Optimized JavaScript code with improved performance
    const LS_KEY = 'metalInventory';
    const SPOT_HISTORY_KEY = 'metalSpotHistory';
    const USER_SPOT_SILVER_KEY = 'userSpotPriceSilver';
    const USER_SPOT_GOLD_KEY = 'userSpotPriceGold';

    // Sorting state
    let sortColumn = null;
    let sortDirection = 'asc'; // 'asc' or 'desc'
    let editingIndex = null; // Track which item is being edited

    // Pagination state
    let currentPage = 1;
    let itemsPerPage = 25;

    // Search state
    let searchQuery = '';

    // DOM Elements (cached for performance)
    const elements = {
      spotPriceDisplaySilver: null,
      spotPriceDisplayGold: null,
      userSpotPriceSilver: null,
      userSpotPriceGold: null,
      inventoryForm: null,
      inventoryTable: null,
      itemMetal: null,
      itemName: null,
      itemQty: null,
      itemType: null,
      itemWeight: null,
      itemPrice: null,
      purchaseLocation: null,
      itemDate: null,
      saveSpotBtnSilver: null,
      resetSpotBtnSilver: null,
      saveSpotBtnGold: null,
      resetSpotBtnGold: null,
      showSpotHistoryBtn: null,
      clearSpotHistoryBtn: null,
      importFile: null,
      boatingAccidentBtn: null,
      editModal: null,
      editForm: null,
      cancelEditBtn: null,
      editMetal: null,
      editName: null,
      editQty: null,
      editType: null,
      editWeight: null,
      editPrice: null,
      editPurchaseLocation: null,
      editDate: null,
      editSpotPrice: null,
      itemsPerPage: null,
      prevPage: null,
      nextPage: null,
      firstPage: null,
      lastPage: null,
      pageNumbers: null,
      paginationInfo: null,
      searchInput: null,
      clearSearchBtn: null,
      searchResultsInfo: null,
      totals: {
        silver: {
          items: null,
          weight: null,
          value: null,
          purchased: null,
          premium: null,
          lossProfit: null
        },
        gold: {
          items: null,
          weight: null,
          value: null,
          purchased: null,
          premium: null,
          lossProfit: null
        },
        all: {
          items: null,
          weight: null,
          value: null,
          purchased: null,
          premium: null,
          lossProfit: null
        }
      }
    };

    // State
    let inventory = [];
    let spotSilver = 0;
    let spotGold = 0;
    let spotHistory = [];

    // Utility Functions
    const pad2 = n => n.toString().padStart(2, '0');
    const todayStr = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };

    // Date parsing function to handle multiple formats
    function parseDate(dateStr) {
      if (!dateStr) return todayStr();

      // Try ISO format (YYYY-MM-DD) first
      let date = new Date(dateStr);
      if (!isNaN(date) && date.toString() !== 'Invalid Date') {
        return date.toISOString().split('T')[0];
      }

      // Try common US format MM/DD/YYYY
      const usMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
      if (usMatch) {
        const month = parseInt(usMatch[1], 10) - 1;
        const day = parseInt(usMatch[2], 10);
        const year = parseInt(usMatch[3], 10);

        if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
          date = new Date(year, month, day);
          if (!isNaN(date) && date.toString() !== 'Invalid Date') {
            return date.toISOString().split('T')[0];
          }
        }
      }

      // Try common European format DD/MM/YYYY
      const euMatch = dateStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
      if (euMatch) {
        const day = parseInt(euMatch[1], 10);
        const month = parseInt(euMatch[2], 10) - 1;
        const year = parseInt(euMatch[3], 10);

        if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
          date = new Date(year, month, day);
          if (!isNaN(date) && date.toString() !== 'Invalid Date') {
            return date.toISOString().split('T')[0];
          }
        }
      }

      // Try YYYY/MM/DD format
      const ymdMatch = dateStr.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
      if (ymdMatch) {
        const year = parseInt(ymdMatch[1], 10);
        const month = parseInt(ymdMatch[2], 10) - 1;
        const day = parseInt(ymdMatch[3], 10);

        if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
          date = new Date(year, month, day);
          if (!isNaN(date) && date.toString() !== 'Invalid Date') {
            return date.toISOString().split('T')[0];
          }
        }
      }

      // If all parsing fails, return today's date
      return todayStr();
    }

    const formatDollar = n => `$${parseFloat(n).toFixed(2)}`;
    const formatLossProfit = (value) => {
      const formatted = formatDollar(value);
      if (value > 0) {
        return `<span style="color: var(--profit);">${formatted}</span>`;
      } else if (value < 0) {
        return `<span style="color: var(--loss);">${formatted}</span>`;
      }
      return formatted;
    };
    const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const loadData = (key, defaultValue = []) => {
      try {
        return JSON.parse(localStorage.getItem(key)) || defaultValue;
      } catch (e) {
        return defaultValue;
      }
    };

    // Search Functionality
    const filterInventory = () => {
      if (!searchQuery.trim()) return inventory;

      const query = searchQuery.toLowerCase();
      return inventory.filter(item => {
        return (
          item.metal.toLowerCase().includes(query) ||
          item.name.toLowerCase().includes(query) ||
          item.type.toLowerCase().includes(query) ||
          item.purchaseLocation.toLowerCase().includes(query) ||
          item.date.includes(query) ||
          item.qty.toString().includes(query) ||
          item.weight.toString().includes(query) ||
          item.price.toString().includes(query) ||
          (item.isCollectable ? 'yes' : 'no').includes(query)
        );
      });
    };

    // Sorting Functionality
    const sortInventory = (data = inventory) => {
      if (sortColumn === null) return data;

      return [...data].sort((a, b) => {
        let valA, valB;

        // Map column index to data property
        switch(sortColumn) {
          case 1: valA = a.metal; valB = b.metal; break; // Metal
          case 2: valA = a.qty; valB = b.qty; break; // Qty
          case 3: valA = a.type; valB = b.type; break; // Type
          case 4: valA = a.name; valB = b.name; break; // Name
          case 5: valA = a.weight; valB = b.weight; break; // Weight
          case 6: valA = a.price; valB = b.price; break; // Purchase Price
          case 7: valA = a.spotPriceAtPurchase; valB = b.spotPriceAtPurchase; break; // Spot Price
          case 8: valA = a.premiumPerOz; valB = b.premiumPerOz; break; // Premium per oz
          case 9: valA = a.totalPremium; valB = b.totalPremium; break; // Total Premium
          case 10: valA = a.purchaseLocation; valB = b.purchaseLocation; break; // Location
          case 11: valA = a.date; valB = b.date; break; // Date
          case 12: valA = a.isCollectable; valB = b.isCollectable; break; // Collectable
          default: return 0;
        }

        // Numeric comparison for numbers
        if (typeof valA === 'number' && typeof valB === 'number') {
          return sortDirection === 'asc' ? valA - valB : valB - valA;
        } 
        // Boolean comparison for collectable
        else if (typeof valA === 'boolean' && typeof valB === 'boolean') {
          return sortDirection === 'asc' ? (valA - valB) : (valB - valA);
        }
        // String comparison for everything else
        else {
          return sortDirection === 'asc' 
            ? String(valA).localeCompare(String(valB)) 
            : String(valB).localeCompare(String(valA));
        }
      });
    };

    // Pagination Functions
    const calculateTotalPages = (data = inventory) => {
      return Math.max(1, Math.ceil(data.length / itemsPerPage));
    };

    const renderPagination = (filteredData = filterInventory()) => {
      const totalPages = calculateTotalPages(filteredData);
      const pageNumbersContainer = elements.pageNumbers;
      pageNumbersContainer.innerHTML = '';

      // Show limited page numbers (max 7) centered around current page
      const maxVisiblePages = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      // Adjust startPage if we're near the end
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // Add page number buttons
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = currentPage === i ? 'active' : '';
        btn.onclick = () => goToPage(i);
        pageNumbersContainer.appendChild(btn);
      }

      // Update pagination info
      elements.paginationInfo.textContent = `${currentPage} of ${totalPages}`;

      // Update button states
      elements.firstPage.disabled = currentPage === 1;
      elements.prevPage.disabled = currentPage === 1;
      elements.nextPage.disabled = currentPage === totalPages;
      elements.lastPage.disabled = currentPage === totalPages;

      // Update search results info
      if (searchQuery.trim()) {
        elements.searchResultsInfo.textContent = `Found ${filteredData.length} results matching "${searchQuery}"`;
      } else {
        elements.searchResultsInfo.textContent = '';
      }
    };

    const goToPage = (page) => {
      const filteredData = filterInventory();
      const totalPages = calculateTotalPages(filteredData);
      currentPage = Math.max(1, Math.min(page, totalPages));
      renderTable();
    };

    // Spot Price Functions
    const saveSpotHistory = () => saveData(SPOT_HISTORY_KEY, spotHistory);
    const loadSpotHistory = () => spotHistory = loadData(SPOT_HISTORY_KEY, []);

    const recordSpot = (newSpot, source, metal) => {
      if (!spotHistory.length || spotHistory[spotHistory.length-1].spot !== newSpot || spotHistory[spotHistory.length-1].metal !== metal) {
        spotHistory.push({
          spot: newSpot,
          metal,
          source,
          timestamp: new Date().toISOString().replace('T',' ').slice(0,19)
        });
        saveSpotHistory();
      }
    };

    const fetchSpotPrice = () => {
      const userSilv = localStorage.getItem(USER_SPOT_SILVER_KEY);
      if (userSilv) {
        spotSilver = parseFloat(userSilv);
        elements.spotPriceDisplaySilver.textContent = formatDollar(spotSilver);
        recordSpot(spotSilver, 'manual', 'Silver');
      } else {
        elements.spotPriceDisplaySilver.textContent = 'N/A';
      }

      const userGold = localStorage.getItem(USER_SPOT_GOLD_KEY);
      if (userGold) {
        spotGold = parseFloat(userGold);
        elements.spotPriceDisplayGold.textContent = formatDollar(spotGold);
        recordSpot(spotGold, 'manual', 'Gold');
      } else {
        elements.spotPriceDisplayGold.textContent = 'N/A';
      }

      updateSummary();
    };

    const updateManualSpot = (metal) => {
      const input = metal === 'Silver' ? elements.userSpotPriceSilver : elements.userSpotPriceGold;
      const value = input.value;

      if (!value) return;

      const num = parseFloat(value);
      if (isNaN(num) || num <= 0) return alert(`Invalid ${metal.toLowerCase()} spot price.`);

      localStorage.setItem(metal === 'Silver' ? USER_SPOT_SILVER_KEY : USER_SPOT_GOLD_KEY, num);
      if (metal === 'Silver') spotSilver = num;
      else spotGold = num;

      elements.spotPriceDisplaySilver.textContent = formatDollar(spotSilver);
      elements.spotPriceDisplayGold.textContent = formatDollar(spotGold);

      updateSummary();
    };

    const resetSpot = (metal) => {
      localStorage.removeItem(metal === 'Silver' ? USER_SPOT_SILVER_KEY : USER_SPOT_GOLD_KEY);
      fetchSpotPrice();
    };

    // Inventory Functions
    const saveInventory = () => saveData(LS_KEY, inventory);
    const loadInventory = () => {
      const data = loadData(LS_KEY, []);
      // Migrate legacy data to include new fields
      inventory = data.map(item => {
        if (item.premiumPerOz === undefined) {
          // For legacy items, calculate premium if possible
          const spotPrice = item.metal === 'Silver' ? spotSilver : spotGold;
          const premiumPerOz = spotPrice > 0 ? (item.price / item.weight) - spotPrice : 0;
          const totalPremium = premiumPerOz * item.qty * item.weight;

          return {
            ...item,
            purchaseLocation: item.purchaseLocation || "Unknown",
            spotPriceAtPurchase: spotPrice,
            premiumPerOz,
            totalPremium,
            isCollectable: item.isCollectable !== undefined ? item.isCollectable : false
          };
        }
        // Ensure all items have isCollectable property
        return {
          ...item,
          isCollectable: item.isCollectable !== undefined ? item.isCollectable : false
        };
      });
    };

    const renderTable = () => {
      const filteredInventory = filterInventory();
      const sortedInventory = sortInventory(filteredInventory);
      const totalPages = calculateTotalPages(sortedInventory);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, sortedInventory.length);

      const rows = [];

      for (let i = startIndex; i < endIndex; i++) {
        const item = sortedInventory[i];
        const originalIdx = inventory.indexOf(item);

        rows.push(`
          <tr>
            <td>${i + 1}</td>
            <td>${item.metal || 'Silver'}</td>
            <td>${item.qty}</td>
            <td>${item.type}</td>
            <td>${item.name.replace(/[<>"']/g, '')}</td>
            <td>${parseFloat(item.weight).toFixed(2)}</td>
            <td>${formatDollar(item.price)}</td>
            <td>${item.isCollectable ? 'N/A' : (item.spotPriceAtPurchase > 0 ? formatDollar(item.spotPriceAtPurchase) : 'N/A')}</td>
            <td style="color: ${item.isCollectable ? 'var(--collectable)' : (item.premiumPerOz > 0 ? 'var(--premium)' : 'inherit')}">${item.isCollectable ? 'N/A' : formatDollar(item.premiumPerOz)}</td>
            <td style="color: ${item.isCollectable ? 'var(--collectable)' : (item.totalPremium > 0 ? 'var(--premium)' : 'inherit')}">${item.isCollectable ? 'N/A' : formatDollar(item.totalPremium)}</td>
            <td>${item.purchaseLocation}</td>
            <td>${item.date}</td>
            <td>
              <label class="switch">
                <input type="checkbox" ${item.isCollectable ? 'checked' : ''} onchange="toggleCollectable(${originalIdx}, this)">
                <span class="slider"></span>
              </label>
            </td>
            <td><button class="btn premium" onclick="editItem(${originalIdx})" aria-label="Edit item">Edit</button></td>
            <td><button class="btn danger" onclick="deleteItem(${originalIdx})" aria-label="Delete item">&times;</button></td>
          </tr>
        `);
      }

      elements.inventoryTable.innerHTML = rows.join('');

      // Update sort indicators
      const headers = document.querySelectorAll('#inventoryTable th');
      headers.forEach(header => {
        const indicator = header.querySelector('.sort-indicator');
        if (indicator) header.removeChild(indicator);
      });

      if (sortColumn !== null && sortColumn < headers.length) {
        const header = headers[sortColumn];
        const indicator = document.createElement('span');
        indicator.className = 'sort-indicator';
        indicator.textContent = sortDirection === 'asc' ? '↑' : '↓';
        header.appendChild(indicator);
      }

      renderPagination(sortedInventory);
      updateSummary();
    };

    const updateSummary = () => {
      const calculateTotals = (metal) => {
        let totalItems = 0;
        let totalWeight = 0;
        let currentSpotValue = 0;
        let totalPurchased = 0;
        let totalPremium = 0;
        let lossProfit = 0;

        for (const item of inventory) {
          if (item.metal === metal) {
            totalItems += Number(item.qty);

            // Total Weight calculation (for both regular and collectible items)
            const itemWeight = Number(item.qty) * parseFloat(item.weight);
            totalWeight += itemWeight;

            // Current Value calculation
            if (item.isCollectable) {
              // For collectible items: Current Value = Current spot price × weight
              const currentSpot = metal === 'Silver' ? spotSilver : spotGold;
              currentSpotValue += currentSpot * itemWeight;
            } else {
              // For regular items: Current Value = Weight × Current Spot Price
              const currentSpot = metal === 'Silver' ? spotSilver : spotGold;
              currentSpotValue += currentSpot * itemWeight;
            }

            // Total Purchase Price calculation (for both regular and collectible items)
            totalPurchased += Number(item.qty) * parseFloat(item.price);

            // Premium Paid calculation
            if (!item.isCollectable) {
              // For regular items: Premium Paid = (Purchase Price per oz - Spot Price at Purchase) × Weight
              const pricePerOz = item.price / item.weight;
              const premiumPerOz = pricePerOz - item.spotPriceAtPurchase;
              totalPremium += premiumPerOz * itemWeight;
            }
            // For collectible items: Premium Paid = N/A

            // Loss/Profit calculation
            if (!item.isCollectable) {
              // For regular items: Loss/Profit = Current Value - Purchase Price
              const currentSpot = metal === 'Silver' ? spotSilver : spotGold;
              const currentValue = currentSpot * itemWeight;
              const purchaseValue = item.price * item.qty;
              lossProfit += currentValue - purchaseValue;
            }
            // For collectible items: Loss/Profit = Omitted from calculation
          }
        }

        return { 
          totalItems, 
          totalWeight, 
          currentSpotValue, 
          totalPurchased, 
          totalPremium,
          lossProfit
        };
      };

      const silver = calculateTotals('Silver');
      const gold = calculateTotals('Gold');

      // Update DOM elements with weight rounded to 2 decimal places
      elements.totals.silver.items.textContent = silver.totalItems;
      elements.totals.silver.weight.textContent = silver.totalWeight.toFixed(2);
      elements.totals.silver.value.innerHTML = formatDollar(silver.currentSpotValue);
      elements.totals.silver.purchased.innerHTML = formatDollar(silver.totalPurchased);
      elements.totals.silver.premium.innerHTML = formatDollar(silver.totalPremium);
      elements.totals.silver.lossProfit.innerHTML = formatLossProfit(silver.lossProfit);

      elements.totals.gold.items.textContent = gold.totalItems;
      elements.totals.gold.weight.textContent = gold.totalWeight.toFixed(2);
      elements.totals.gold.value.innerHTML = formatDollar(gold.currentSpotValue);
      elements.totals.gold.purchased.innerHTML = formatDollar(gold.totalPurchased);
      elements.totals.gold.premium.innerHTML = formatDollar(gold.totalPremium);
      elements.totals.gold.lossProfit.innerHTML = formatLossProfit(gold.lossProfit);

      elements.totals.all.items.textContent = silver.totalItems + gold.totalItems;
      elements.totals.all.weight.textContent = (silver.totalWeight + gold.totalWeight).toFixed(2);
      elements.totals.all.value.innerHTML = formatDollar(silver.currentSpotValue + gold.currentSpotValue);
      elements.totals.all.purchased.innerHTML = formatDollar(silver.totalPurchased + gold.totalPurchased);
      elements.totals.all.premium.innerHTML = formatDollar(silver.totalPremium + gold.totalPremium);
      elements.totals.all.lossProfit.innerHTML = formatLossProfit(silver.lossProfit + gold.lossProfit);
    };

    const deleteItem = (idx) => {
      if (confirm("Delete this item?")) {
        inventory.splice(idx, 1);
        saveInventory();
        renderTable();
      }
    };

    const editItem = (idx) => {
      editingIndex = idx;
      const item = inventory[idx];

      // Populate edit form
      elements.editMetal.value = item.metal;
      elements.editName.value = item.name;
      elements.editQty.value = item.qty;
      elements.editType.value = item.type;
      elements.editWeight.value = item.weight;
      elements.editPrice.value = item.price;
      elements.editPurchaseLocation.value = item.purchaseLocation;
      elements.editDate.value = item.date;
      elements.editSpotPrice.value = item.spotPriceAtPurchase;

      // Show modal
      elements.editModal.style.display = 'flex';
    };

    const toggleCollectable = (idx, checkbox) => {
      inventory[idx].isCollectable = checkbox.checked;
      saveInventory();
      renderTable();
    };

    // Event Listeners
    const setupEventListeners = () => {
      // Table header sorting
      const headers = document.querySelectorAll('#inventoryTable th');
      headers.forEach((header, index) => {
        // Skip # column (0) and Edit/Delete columns (13-14)
        if (index === 0 || index >= headers.length - 2) {
          return;
        }

        header.style.cursor = 'pointer';

        header.addEventListener('click', () => {
          // Toggle sort direction if same column, otherwise set to new column with asc
          if (sortColumn === index) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = index;
            sortDirection = 'asc';
          }

          renderTable();
        });
      });

      elements.inventoryForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const metal = elements.itemMetal.value;
        const name = elements.itemName.value.trim();
        const qty = parseInt(elements.itemQty.value, 10);
        const type = elements.itemType.value;
        const weight = parseFloat(elements.itemWeight.value);
        const price = parseFloat(elements.itemPrice.value);
        const purchaseLocation = elements.purchaseLocation.value.trim() || "Unknown";
        const date = elements.itemDate.value || todayStr();

        if (isNaN(qty) || qty < 1 || !Number.isInteger(qty) ||
            isNaN(weight) || weight <= 0 ||
            isNaN(price) || price < 0) {
          return alert("Please enter valid values for all fields.");
        }

        // Get current spot price
        const spotPriceAtPurchase = metal === 'Silver' ? spotSilver : spotGold;

        // Calculate premium per ounce (only for non-collectible items)
        let premiumPerOz = 0;
        let totalPremium = 0;

        // For new items, they're not collectable by default
        const isCollectable = false;

        if (!isCollectable) {
          const pricePerOz = price / weight;
          premiumPerOz = pricePerOz - spotPriceAtPurchase;
          totalPremium = premiumPerOz * qty * weight;
        }

        inventory.push({ 
          metal, 
          name, 
          qty, 
          type, 
          weight, 
          price, 
          date,
          purchaseLocation,
          spotPriceAtPurchase,
          premiumPerOz,
          totalPremium,
          isCollectable
        });

        saveInventory();
        renderTable();
        this.reset();
        elements.itemDate.value = todayStr();
      });

      // Edit form submission
      elements.editForm.addEventListener('submit', function(e) {
        e.preventDefault();

        if (editingIndex === null) return;

        const metal = elements.editMetal.value;
        const name = elements.editName.value.trim();
        const qty = parseInt(elements.editQty.value, 10);
        const type = elements.editType.value;
        const weight = parseFloat(elements.editWeight.value);
        const price = parseFloat(elements.editPrice.value);
        const purchaseLocation = elements.editPurchaseLocation.value.trim() || "Unknown";
        const date = elements.editDate.value;
        const spotPriceAtPurchase = parseFloat(elements.editSpotPrice.value);

        // Keep the existing collectable status
        const isCollectable = inventory[editingIndex].isCollectable;

        if (isNaN(qty) || qty < 1 || !Number.isInteger(qty) ||
            isNaN(weight) || weight <= 0 ||
            isNaN(price) || price < 0 ||
            (!isCollectable && (isNaN(spotPriceAtPurchase) || spotPriceAtPurchase <= 0))) {
          return alert("Please enter valid values for all fields.");
        }

        // Calculate premium per ounce (only for non-collectible items)
        let premiumPerOz = 0;
        let totalPremium = 0;

        if (!isCollectable) {
          const pricePerOz = price / weight;
          premiumPerOz = pricePerOz - spotPriceAtPurchase;
          totalPremium = premiumPerOz * qty * weight;
        }

        // Update the item
        inventory[editingIndex] = {
          metal,
          name,
          qty,
          type,
          weight,
          price,
          date,
          purchaseLocation,
          spotPriceAtPurchase: isCollectable ? 0 : spotPriceAtPurchase,
          premiumPerOz,
          totalPremium,
          isCollectable
        };

        saveInventory();
        renderTable();

        // Close modal
        elements.editModal.style.display = 'none';
        editingIndex = null;
      });

      // Cancel edit
      elements.cancelEditBtn.addEventListener('click', function() {
        elements.editModal.style.display = 'none';
        editingIndex = null;
      });

      // Spot Price Event Listeners
      elements.saveSpotBtnSilver.addEventListener('click', () => updateManualSpot('Silver'));
      elements.resetSpotBtnSilver.addEventListener('click', () => resetSpot('Silver'));
      elements.userSpotPriceSilver.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') updateManualSpot('Silver');
      });

      elements.saveSpotBtnGold.addEventListener('click', () => updateManualSpot('Gold'));
      elements.resetSpotBtnGold.addEventListener('click', () => resetSpot('Gold'));
      elements.userSpotPriceGold.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') updateManualSpot('Gold');
      });

      // Spot History Functions
      elements.showSpotHistoryBtn.addEventListener('click', function() {
        if (spotHistory.length === 0) {
          alert("No spot history available.");
          return;
        }

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal';

        const content = document.createElement('div');
        content.className = 'modal-content';

        const title = document.createElement('h2');
        title.textContent = 'Spot Price History';
        title.style.marginBottom = '1rem';
        title.style.color = 'var(--accent)';

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ced4da; color: var(--accent);">Timestamp</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ced4da; color: var(--accent);">Spot Price</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ced4da; color: var(--accent);">Metal</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ced4da; color: var(--accent);">Source</th>
          </tr>
        `;

        const tbody = document.createElement('tbody');
        spotHistory.slice().reverse().forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding: 8px; border-bottom: 1px solid #ced4da; color: var(--fg);">${entry.timestamp}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ced4da; color: var(--fg);">${formatDollar(entry.spot)}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ced4da; color: var(--fg);">${entry.metal}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ced4da; color: var(--fg);">${entry.source}</td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(thead);
        table.appendChild(tbody);

        const closeButton = document.createElement('button');
        closeButton.textContent = 'Close';
        closeButton.className = 'btn';
        closeButton.style.marginTop = '1rem';
        closeButton.addEventListener('click', () => {
          document.body.removeChild(modal);
        });

        content.appendChild(title);
        content.appendChild(table);
        content.appendChild(closeButton);
        modal.appendChild(content);
        document.body.appendChild(modal);
      });

      elements.clearSpotHistoryBtn.addEventListener('click', function() {
        if (confirm("Are you sure you want to clear all spot history?")) {
          spotHistory = [];
          saveSpotHistory();
          alert("Spot history cleared.");
        }
      });

      // Import/Export Functions
      elements.importFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            let imported = [];
            let skipped = 0;

            for (let row of results.data) {
              const metal = row['Metal'] || 'Silver';
              const name = row['Name'] || row['name'];
              const qty = parseInt(row['Qty'] || row['qty'] || 1, 10);
              const type = row['Type'] || row['type'] || 'Other';
              const weight = parseFloat(row['Weight(oz)'] || row['weight']);
              const priceStr = row['Purchase Price'] || row['price'];
              const price = parseFloat(typeof priceStr === "string" ? priceStr.replace(/[^0-9.-]+/g,"") : priceStr);
              const purchaseLocation = row['Purchase Location'] || "Unknown";
              const date = parseDate(row['Date']); // Using the new date parser

              // Get collectable status
              const isCollectable = row['Collectable'] === 'Yes' || row['Collectable'] === 'true' || row['isCollectable'] === 'true';

              // Get spot price from CSV if available
              let spotPriceAtPurchase;
              if (row['Spot Price ($/oz)']) {
                // Extract numeric value from formatted string like "$1,234.56"
                const spotStr = row['Spot Price ($/oz)'].toString();
                spotPriceAtPurchase = parseFloat(spotStr.replace(/[^0-9.-]+/g, ""));
              } else if (row['spotPriceAtPurchase']) {
                spotPriceAtPurchase = parseFloat(row['spotPriceAtPurchase']);
              } else {
                // Fall back to current spot price if not in CSV and not collectable
                spotPriceAtPurchase = isCollectable ? 0 : (metal === 'Silver' ? spotSilver : spotGold);
              }

              // Calculate premium per ounce (only for non-collectible items)
              let premiumPerOz = 0;
              let totalPremium = 0;

              if (!isCollectable) {
                const pricePerOz = price / weight;
                premiumPerOz = pricePerOz - spotPriceAtPurchase;
                totalPremium = premiumPerOz * qty * weight;
              }

              if (!name || isNaN(qty) || isNaN(weight) || isNaN(price) || qty < 1 || !Number.isInteger(qty)) {
                skipped++;
                continue;
              }

              imported.push({ 
                metal, 
                name, 
                qty, 
                type, 
                weight, 
                price, 
                date,
                purchaseLocation,
                spotPriceAtPurchase,
                premiumPerOz,
                totalPremium,
                isCollectable
              });
            }

            if (imported.length === 0) return alert("No valid items to import.");

            let msg = "Replace current inventory with imported file?";
            if (skipped > 0) msg += `\n(Skipped ${skipped} invalid rows)`;

            if (confirm(msg)) {
              inventory = imported;
              saveInventory();
              renderTable();
            }

            this.value = "";
          }
        });
      });

      // Boating Accident Button
      elements.boatingAccidentBtn.addEventListener('click', function() {
        if (confirm("WARNING: This will erase ALL your data for this app (inventory, spot history, spot prices).\n\nAre you sure you want to proceed?\n\nThis action cannot be undone!")) {
          localStorage.removeItem(LS_KEY);
          localStorage.removeItem(SPOT_HISTORY_KEY);
          localStorage.removeItem(USER_SPOT_SILVER_KEY);
          localStorage.removeItem(USER_SPOT_GOLD_KEY);
          sessionStorage.clear();

          loadInventory();
          renderTable();
          loadSpotHistory();
          fetchSpotPrice();
          alert("All data has been erased.");
        }
      });
    };

    // Pagination Event Listeners
    const setupPagination = () => {
      elements.itemsPerPage.addEventListener('change', function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        renderTable();
      });

      elements.prevPage.addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });

      elements.nextPage.addEventListener('click', function() {
        const totalPages = calculateTotalPages(filterInventory());
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });

      elements.firstPage.addEventListener('click', function() {
        currentPage = 1;
        renderTable();
      });

      elements.lastPage.addEventListener('click', function() {
        currentPage = calculateTotalPages(filterInventory());
        renderTable();
      });
    };

    // Search Event Listeners
    const setupSearch = () => {
      elements.searchInput.addEventListener('input', function() {
        searchQuery = this.value;
        currentPage = 1; // Reset to first page when search changes
        renderTable();
      });

      elements.clearSearchBtn.addEventListener('click', function() {
        elements.searchInput.value = '';
        searchQuery = '';
        currentPage = 1;
        renderTable();
      });
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize DOM elements after DOM is loaded
      elements.spotPriceDisplaySilver = document.getElementById('spotPriceDisplaySilver');
      elements.spotPriceDisplayGold = document.getElementById('spotPriceDisplayGold');
      elements.userSpotPriceSilver = document.getElementById('userSpotPriceSilver');
      elements.userSpotPriceGold = document.getElementById('userSpotPriceGold');
      elements.inventoryForm = document.getElementById('inventoryForm');
      elements.inventoryTable = document.getElementById('inventoryTable').querySelector('tbody');
      elements.itemMetal = document.getElementById('itemMetal');
      elements.itemName = document.getElementById('itemName');
      elements.itemQty = document.getElementById('itemQty');
      elements.itemType = document.getElementById('itemType');
      elements.itemWeight = document.getElementById('itemWeight');
      elements.itemPrice = document.getElementById('itemPrice');
      elements.purchaseLocation = document.getElementById('purchaseLocation');
      elements.itemDate = document.getElementById('itemDate');
      elements.saveSpotBtnSilver = document.getElementById('saveSpotBtnSilver');
      elements.resetSpotBtnSilver = document.getElementById('resetSpotBtnSilver');
      elements.saveSpotBtnGold = document.getElementById('saveSpotBtnGold');
      elements.resetSpotBtnGold = document.getElementById('resetSpotBtnGold');
      elements.showSpotHistoryBtn = document.getElementById('showSpotHistoryBtn');
      elements.clearSpotHistoryBtn = document.getElementById('clearSpotHistoryBtn');
      elements.importFile = document.getElementById('importFile');
      elements.boatingAccidentBtn = document.getElementById('boatingAccidentBtn');
      elements.editModal = document.getElementById('editModal');
      elements.editForm = document.getElementById('editForm');
      elements.cancelEditBtn = document.getElementById('cancelEdit');
      elements.editMetal = document.getElementById('editMetal');
      elements.editName = document.getElementById('editName');
      elements.editQty = document.getElementById('editQty');
      elements.editType = document.getElementById('editType');
      elements.editWeight = document.getElementById('editWeight');
      elements.editPrice = document.getElementById('editPrice');
      elements.editPurchaseLocation = document.getElementById('editPurchaseLocation');
      elements.editDate = document.getElementById('editDate');
      elements.editSpotPrice = document.getElementById('editSpotPrice');
      elements.itemsPerPage = document.getElementById('itemsPerPage');
      elements.prevPage = document.getElementById('prevPage');
      elements.nextPage = document.getElementById('nextPage');
      elements.firstPage = document.getElementById('firstPage');
      elements.lastPage = document.getElementById('lastPage');
      elements.pageNumbers = document.getElementById('pageNumbers');
      elements.paginationInfo = document.getElementById('paginationInfo');
      elements.searchInput = document.getElementById('searchInput');
      elements.clearSearchBtn = document.getElementById('clearSearchBtn');
      elements.searchResultsInfo = document.getElementById('searchResultsInfo');

      // Initialize totals elements
      elements.totals.silver.items = document.getElementById('totalItemsSilver');
      elements.totals.silver.weight = document.getElementById('totalWeightSilver');
      elements.totals.silver.value = document.getElementById('currentValueSilver');
      elements.totals.silver.purchased = document.getElementById('totalPurchasedSilver');
      elements.totals.silver.premium = document.getElementById('totalPremiumSilver');
      elements.totals.silver.lossProfit = document.getElementById('lossProfitSilver');

      elements.totals.gold.items = document.getElementById('totalItemsGold');
      elements.totals.gold.weight = document.getElementById('totalWeightGold');
      elements.totals.gold.value = document.getElementById('currentValueGold');
      elements.totals.gold.purchased = document.getElementById('totalPurchasedGold');
      elements.totals.gold.premium = document.getElementById('totalPremiumGold');
      elements.totals.gold.lossProfit = document.getElementById('lossProfitGold');

      elements.totals.all.items = document.getElementById('totalItemsAll');
      elements.totals.all.weight = document.getElementById('totalWeightAll');
      elements.totals.all.value = document.getElementById('currentValueAll');
      elements.totals.all.purchased = document.getElementById('totalPurchasedAll');
      elements.totals.all.premium = document.getElementById('totalPremiumAll');
      elements.totals.all.lossProfit = document.getElementById('lossProfitAll');

      // Initialize app
      elements.itemDate.value = todayStr();
      loadInventory();
      loadSpotHistory();
      renderTable();
      fetchSpotPrice();

      // Setup event listeners
      setupEventListeners();
      setupPagination();
      setupSearch();
    });

    // Export Functions
    const downloadCSV = () => {
      const timestamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
      const headers = ["Metal","Name","Qty","Type","Weight(oz)","Purchase Price","Spot Price ($/oz)","Premium ($/oz)","Total Premium","Purchase Location","Date","Collectable"];
      const rows = [];

      for (const i of inventory) {
        // For collectable items, use current spot price (at time of export)
        // This ensures the value is preserved if the item is later changed back to standard
        const exportSpotPrice = i.isCollectable ? 
          (i.metal === 'Silver' ? spotSilver : spotGold) : 
          i.spotPriceAtPurchase;

        rows.push([
          i.metal || 'Silver',
          i.name,
          i.qty,
          i.type,
          parseFloat(i.weight).toFixed(4),
          formatDollar(i.price),
          exportSpotPrice > 0 ? formatDollar(exportSpotPrice) : 'N/A',
          i.isCollectable ? 'N/A' : formatDollar(i.premiumPerOz),
          i.isCollectable ? 'N/A' : formatDollar(i.totalPremium),
          i.purchaseLocation,
          i.date,
          i.isCollectable ? 'Yes' : 'No'
        ]);
      }

      const csv = Papa.unparse([headers, ...rows]);
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `metal_inventory_${timestamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    // Make toggleCollectable available globally
    window.toggleCollectable = toggleCollectable;
  </script>
</body>
</html>
