<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - Precious Metals Tool</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; }
        .test-section { background: #f8f9fa; padding: 1.5rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid #0d6efd; }
        .success { border-left-color: #198754; background: #d1eddd; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .info { border-left-color: #0dcaf0; background: #cff4fc; }
        .code { background: #f1f3f4; padding: 0.5rem; border-radius: 4px; font-family: monospace; }
        button { background: #0d6efd; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; margin: 0.5rem; }
        button:hover { background: #0b5ed7; }
        .result { margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px; }
        pre { background: #f1f3f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Precious Metals Tool - Integration Test</h1>
    <p>This page verifies that your file:// vs web server API integration is working correctly.</p>

    <div class="test-section info">
        <h3>üìç Current Environment</h3>
        <p><strong>Protocol:</strong> <span id="protocol"></span></p>
        <p><strong>Mode:</strong> <span id="mode"></span></p>
        <p><strong>Can Make API Calls:</strong> <span id="canMakeApi"></span></p>
    </div>

    <div class="test-section">
        <h3>üß™ API Integration Test</h3>
        <button onclick="testApiIntegration()">Test Vercel API Connection</button>
        <div id="apiResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h3>üìä Environment Diagnostics</h3>
        <button onclick="runDiagnostics()">Run Full Diagnostics</button>
        <div id="diagnosticsResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section success">
        <h3>‚úÖ Expected Behavior</h3>
        <p><strong>File:// Mode:</strong> API calls are safely skipped. Manual price entry works normally.</p>
        <p><strong>Web Server Mode:</strong> API integration attempts to fetch live prices from Vercel.</p>
        <p><strong>Fallback:</strong> If API fails, manual prices are used without errors.</p>
    </div>

    <div class="test-section warning">
        <h3>üí° How to Test Both Modes</h3>
        <p><strong>File Mode:</strong> Open this page directly (file:// protocol)</p>
        <p><strong>Web Mode:</strong> Run <span class="code">python -m http.server 8000</span> and visit <span class="code">http://localhost:8000/integration-test.html</span></p>
    </div>

    <script>
        // Basic environment detection
        function updateEnvironmentInfo() {
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('mode').textContent = window.location.protocol === 'file:' ? 'Offline (File)' : 'Online (Web Server)';
            document.getElementById('canMakeApi').textContent = window.location.protocol !== 'file:' && typeof fetch !== 'undefined' ? 'Yes' : 'No';
        }

        // Test API integration
        async function testApiIntegration() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>üîÑ Testing...</p>';

            if (window.location.protocol === 'file:') {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ File:// Mode Working Correctly</h4>
                        <p>API calls are properly disabled in file:// mode. This prevents CORS errors.</p>
                        <p><strong>Status:</strong> Integration working as expected</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch('https://precious-metals-vercel-api.vercel.app/api/prices');
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ API Integration Working</h4>
                        <p><strong>Status:</strong> Successfully connected to Vercel API</p>
                        <p><strong>Response:</strong> Received ${Object.keys(data).length} metal prices</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="warning">
                        <h4>‚ö†Ô∏è API Connection Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Fallback:</strong> Manual prices will be used (this is normal behavior)</p>
                    </div>
                `;
            }
        }

        // Run comprehensive diagnostics
        function runDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            resultDiv.style.display = 'block';

            const diagnostics = {
                timestamp: new Date().toISOString(),
                environment: {
                    protocol: window.location.protocol,
                    hostname: window.location.hostname,
                    isFile: window.location.protocol === 'file:',
                    hasFetch: typeof fetch !== 'undefined',
                    hasLocalStorage: typeof localStorage !== 'undefined',
                    userAgent: navigator.userAgent
                },
                integration: {
                    canMakeApiCalls: window.location.protocol !== 'file:' && typeof fetch !== 'undefined',
                    expectedBehavior: window.location.protocol === 'file:' ? 
                        'Manual prices only (API disabled)' : 
                        'API integration enabled with manual fallback'
                },
                recommendations: window.location.protocol === 'file:' ?
                    ['Integration working correctly for offline mode'] :
                    ['Test API connection using button above', 'Check Vercel API status if connection fails']
            };

            resultDiv.innerHTML = `
                <h4>üìã System Diagnostics</h4>
                <pre>${JSON.stringify(diagnostics, null, 2)}</pre>
            `;
        }

        // Initialize
        updateEnvironmentInfo();
    </script>
</body>
</html>
